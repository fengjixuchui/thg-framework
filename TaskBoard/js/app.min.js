var taskBoardServices=angular.module("TaskBoardServices",[]),taskBoardControllers=angular.module("TaskBoardControllers",[]),taskBoardDirectives=angular.module("TaskBoardDirectives",[]),taskBoard=angular.module("TaskBoard","ngRoute ngSanitize ng-context-menu TaskBoardServices TaskBoardControllers TaskBoardDirectives".split(" "));
taskBoard.config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{controller:"LoginCtrl",templateUrl:"partials/login.html"}).when("/boards",{controller:"BoardCtrl",templateUrl:"partials/boardSelect.html",authRequired:!0}).when("/boards/:boardId",{controller:"BoardCtrl",templateUrl:"partials/board.html",authRequired:!0,resolve:{validation:["$q","$route",function(a,c){var b=a.defer(),f=parseInt(c.current.params.boardId);isNaN(f)?b.reject("INVALID BOARD ID"):b.resolve();return b.promise}]}}).when("/settings",
{controller:"SettingsCtrl",templateUrl:"partials/settings.html",authRequired:!0}).when("/files/:fileId",{controller:"FilesCtrl",templateUrl:"partials/files.html",authRequired:!0}).otherwise({redirectTo:"/"});b.interceptors.push("TokenInterceptor")}]);
taskBoard.run(["$rootScope","$location","$window","AuthenticationService",function(a,b,d,c){a.version="v0.3.1";a.$on("$routeChangeStart",function(a,f,g){null===f||null===f.authRequired||!f.authRequired||c.isAuthenticated||d.localStorage.token||b.path("/");null!==f&&"LoginCtrl"===f.controller&&d.localStorage.token&&b.path("/boards")});a.$on("$routeChangeSuccess",function(a,b,g){"LoginCtrl"===b.controller&&g&&""!==g.originalPath&&(c.attemptedRoute=g)});a.$on("$routeChangeError",function(a,c,g,d){"INVALID BOARD ID"===
d&&b.path("/boards")})}]);taskBoardControllers.controller("ItemFormBoardCtrl",["$scope","BoardService",function(a,b){a.itemFormData={setFocus:!1,isSaving:!1,isAdd:!0,itemId:0,title:"",titleError:!1,description:"",assignee:0,category:0,lane:0,color:"#ffffe0",dueDate:null,points:null,pointsError:!1,reset:function(c){$(".popover-dismiss").popover({html:!0});this.setFocus=!0;this.isSaving=!1;this.isAdd=!0;this.itemId=0;this.title="";this.titleError=!1;this.description="";this.category=this.assignee=0;this.lane=c||0;this.color=
"#ffffe0";this.spectrum();this.points=this.dueDate=null;this.pointsError=!1;var b=this;$(".itemModal").on("hidden.bs.modal",function(a){b.reset()});a.quickAdd.title[c]&&this.quickAddItem(c)},quickAddItem:function(c){$(".itemModal").on("show.bs.modal",function(a){a.stopPropogation()});this.title=a.quickAdd.title[c];a.submitItem(this);delete a.quickAdd.title[c]},loadItem:function(a){this.reset(a.lane_id);this.isAdd=!1;this.itemId=a.id;this.title=a.title;this.description=a.description;this.assignee=
"0"===a.assignee?0:a.assignee;this.category="0"===a.category?0:a.category;this.color=a.color;this.spectrum(this.color);this.dueDate=a.due_date;this.points=parseInt(a.points);this.position=a.position},cancel:function(){$(".itemModal").modal("hide");$("#spectrum").spectrum("hide");$("#spectrum").spectrum("enable")},spectrum:function(a){a=a||"#ffffe0";$("#spectrum").spectrum({color:a,allowEmpty:!1,localStorageKey:"taskboard.colorPalette",showPalette:!0,palette:["#fff #ececec #ffffe0 #ffe0fa #bee7f4 #c3f4b5 #debee8 #ffdea9 #ffbaba".split(" ")],
showSelectionPalette:!0,showButtons:!1,showInput:!0,preferredFormat:"hex3",appendTo:"#addEdit"})},datePicker:function(){$("#datepicker").datepicker()}};a.$parent.itemFormData=a.itemFormData;a.submitItem=function(c){c.isSaving=!0;$("#spectrum").spectrum("disable");c.titleError=!1;""===c.title?(a.alerts.showAlert({type:"error",text:"Title is required to add a new item."}),c.isSaving=!1,c.titleError=!0):(c.pointsError=!1,void 0===c.points?(a.alerts.showAlert({type:"error",text:"Points must be greater than or equal to zero (or left empty)."}),
c.isSaving=!1,c.pointsError=!0):c.isAdd?b.addItem(c,a.currentBoard.id).success(function(a){d(a)}):b.updateItem(c).success(function(a){d(a)}))};a.$parent.submitItem=a.submitItem;var d=function(b){a.alerts.showAlerts(b.alerts);"success"==b.alerts[0].type&&(a.updateBoards(b),a.itemFormData.cancel())}}]);taskBoardControllers.controller("ItemViewBoardCtrl",["$scope","$window","BoardService",function(a,b,d){a.viewItem={};a.comment={};a.toggle={sidebar:!1};a.fileReset=!1;a.comments={options:[{id:0,text:"Oldest First"},{id:1,text:"Newest First"}],sorting:0};a.markedComment=function(a){return a?b.marked(a):"<p>No text</p>"};var c=function(a){if(void 0!==a){var b=new Date;a.forEach(function(a){b.setTime(1E3*a.timestamp);a.date=b.toLocaleString()})}},e=function(b){a.viewItem=b;a.viewItem.laneName=a.laneNames[b.lane_id];
c(a.viewItem.ownComment);c(a.viewItem.ownAttachment);c(a.viewItem.ownActivity)};a.setColor=function(b){var c=b.color;if(b.color!=a.currentBoard.ownCategory[0].color)return b.color;a.currentBoard.ownCategory.forEach(function(a){a.id==b.category&&(c=a.color)});return c};a.openItem=function(b,c){void 0===c&&(c=!0);e(b);a.viewItem.disabled=!1;void 0===a.viewItem.ownComment&&(a.viewItem.ownComment=[]);void 0===a.viewItem.ownAttachment&&(a.viewItem.ownAttachment=[]);a.fileReset=!0;c&&($(".itemViewModal textarea").css("height",
"auto"),$(".itemViewModal").modal({show:!0,keyboard:!1}))};a.$parent.openItem=a.openItem;a.editItem=function(){a.itemFormData.loadItem(a.viewItem);$(".itemViewModal").modal("hide");$(".itemModal").modal("show")};a.deleteItem=function(){noty({text:"Deleting an item cannot be undone.<br>Continue?",layout:"center",type:"information",modal:!0,buttons:[{addClass:"btn btn-default",text:"Ok",onClick:function(b){b.close();a.viewItem.disabled=!0;d.removeItem(a.viewItem.id).success(function(b){a.alerts.showAlerts(b.alerts);
"success"==b.alerts[0].type&&(a.updateBoards(b),$(".itemViewModal").modal("hide"))})}},{addClass:"btn btn-info",text:"Cancel",onClick:function(a){a.close()}}]})};a.$parent.deleteItem=a.deleteItem;a.deleteComment=function(b){noty({text:"Deleting a comment cannot be undone.<br>Continue?",layout:"center",type:"information",modal:!0,buttons:[{addClass:"btn btn-default",text:"Ok",onClick:function(c){c.close();d.removeItemComment(a.viewItem.id,b).success(function(b){a.alerts.showAlerts(b.alerts);"success"==
b.alerts[0].type&&e(b.data[0]);a.loadBoards()})}},{addClass:"btn btn-info",text:"Cancel",onClick:function(a){a.close()}}]})};a.attachmentDeleting=[];a.deleteAttachment=function(b){noty({text:"Deleting an attachment cannot be undone.<br>Continue?",layout:"center",type:"information",modal:!0,buttons:[{addClass:"btn btn-default",text:"Ok",onClick:function(c){c.close();a.attachmentDeleting[b]=!0;d.removeItemAttachment(a.viewItem.id,b).success(function(b){a.alerts.showAlerts(b.alerts);"success"==b.alerts[0].type&&
e(b.data[0]);a.loadBoards()})}},{addClass:"btn btn-info",text:"Cancel",onClick:function(a){a.close()}}]})};a.addItemComment=function(b){""===b||void 0===b?a.alerts.showAlert({type:"error",text:"Comment cannot be empty."}):(a.viewItem.disabled=!0,d.addItemComment(a.viewItem.id,b).success(function(b){e(b.data[0]);a.loadBoards();a.viewItem.disabled=!1}),a.comment.text="")};a.beginEditComment=function(b,c){a.comment.isEdit=!0;a.comment.editText=c;a.comment.id=b};a.editComment=function(b,c){a.comment.isEdit=
!1;""===c||void 0===c?a.alerts.showAlert({type:"error",text:"Comment cannot be empty."}):(a.viewItem.disabled=!0,d.updateItemComment(b,c).success(function(b){e(b.data[0]);a.loadBoards();a.viewItem.disabled=!1}))};a.addItemAttachment=function(){void 0===a.itemUpload||""===a.itemUpload.name?a.alerts.showAlert({type:"error",text:"Select a file before uploading."}):(a.viewItem.disabled=!0,d.addItemAttachment(a.viewItem.id,a.itemUpload).success(function(b){e(b.data[0]);a.loadBoards();a.viewItem.disabled=
!1;a.fileReset=!0}).error(function(b){a.viewItem.disabled=!1;a.fileReset=!0;console.log(b);a.alerts.showAlert({type:"error",text:"There was an error with your attachment. The file may be too large."})}))}}]);taskBoardControllers.controller("BoardCtrl",["$scope","$routeParams","$location","$interval","$window","UserService","BoardService","AlertService","AuthenticationService",function(a,b,d,c,e,f,g,h,m){if(m.attemptedRoute){var k=m.attemptedRoute,n=k.originalPath;k.keys.forEach(function(a){n=n.replace(":"+a.name,k.params[a.name])});m.attemptedRoute=null;d.path(n)}a.quickAdd={title:[]};a.alerts=h;a.marked=function(b){return b?e.marked(hyperlink(b,a.trackers)):""};a.boardId=b.boardId;a.filter={user:null,
category:null,hide:!1};a.filterChanged=function(){a.currentBoard.ownLane.forEach(function(b){b.ownItem&&b.ownItem.forEach(function(b){b.filtered=!1;null!==a.filter.user&&a.filter.user!=b.assignee&&(b.filtered=!0);null!==a.filter.category&&a.filter.category!=b.category&&(b.filtered=!0)})})};a.selectBoard=function(){d.path("boards/"+a.boardNames.current)};a.openEditItem=function(){a.itemFormData.loadItem(a.contextItem);$(".itemModal textarea").css("height","auto");$(".itemModal").modal("show")};a.openAddItem=
function(){a.itemFormData.reset(a.contextLaneId);$(".itemModal textarea").css("height","auto");$(".itemModal").modal("show")};a.removeItem=function(){a.openItem(a.contextItem,!1);a.deleteItem()};a.changeItemLane=function(){a.itemFormData.loadItem(a.contextItem);a.itemFormData.isAdd=!1;a.submitItem(a.itemFormData)};a.contextItem={};a.onContextMenu=function(b,c){a.contextItem=c;a.contextLaneId=b};a.interval=c(function(){a.boardId&&c.cancel(a.interval);a.boardsLoaded&&!a.boardId&&a.currentUser&&parseInt(a.currentUser.defaultBoard)&&
(c.cancel(a.interval),d.path("boards/"+a.currentUser.defaultBoard))},250);a.$on("$destroy",function(){c.cancel(a.interval)});a.boards=[];a.boardsLoaded=!1;a.boardNames=[];a.userNames=[];a.laneNames=[];a.categories=[];a.trackers=[];a.currentBoard={loading:!0,name:"Kanban Board App"};var p=!1,l=0;a.isActiveFilter=function(b){var c=!1;a.boards.forEach(function(a){a.id===b.id&&(c="1"===a.active)},this);return c};a.loadBoards=function(){p||l||(p=!0,g.getBoards().success(function(b){p=!1;a.updateBoards(b)}))};
a.loadBoards();a.boardInterval=c(a.loadBoards,1E4);a.$on("$destroy",function(){c.cancel(a.boardInterval)});a.updateBoards=function(b){if(0===l){a.boards=b.data;a.boardsLoaded=!0;var c=!1;a.boards&&(a.boardNames=[],a.boards.forEach(function(b){1===parseInt(b.active)&&a.boardNames.push({id:b.id,name:b.name});b.id==a.boardId&&(b.sharedUser.unshift({id:0,username:"Unassigned"}),b.sharedUser.forEach(function(b){a.userNames[b.id]=b.username}),b.ownLane.forEach(function(b){a.laneNames[b.id]=b.name;b.ownItem&&
b.ownItem.forEach(function(a){var b=new Date(a.due_date)-Date.now();0>b?a.datePast=!0:2592E5>b&&(a.dateNear=!0);a.position=parseInt(a.position)})}),b.ownCategory&&(b.ownCategory.unshift({id:0,name:"Uncategorized",color:"#ffffe0"}),b.ownCategory.forEach(function(b){a.categories[b.id]=b.name})),b.ownTracker&&b.ownTracker.forEach(function(b){a.trackers[b.id]=[b.name,b.bugexpr]}),a.currentBoard=b,a.boardNames.current=b.id,c=!0)}));c?(a.filterChanged(),a.currentBoard.loading=!1,"0"===a.currentBoard.active&&
(a.currentBoard={loading:!0,name:"Kanban Board App",error:!0})):a.currentBoard.error=!0}};a.toggleLane=function(b){b.collapsed=!b.collapsed;l++;g.toggleLane(b.id).success(function(b){l--;a.updateBoards(b)})};a.updateSortables=function(){var a=this.$parent;$(".itemContainer").sortable({connectWith:".itemContainer",placeholder:"draggable-placeholder",items:"div:not(.addItem, .itemHeader, .description)",change:function(a,b){var c=$(b).parent(),d=c.find(".addItem");d.detach();c.append(d)},stop:function(b,
c){var d=$.find(".boardColumn"),e=[];$(d).each(function(){var a=$(this).attr("data-lane-id");$(this).find(".boardItem").each(function(b){var c=$(this).attr("data-item-id");e.push({item:c,lane:a,position:b})})});a.updatePositions(e)}})};a.updatePositions=function(b){l++;g.updateItemPositions(b).success(function(b){l--;a.updateBoards(b)})};a.currentUser={};a.userLoaded=!1;a.updateCurrentUser=function(){f.currentUser().success(function(b){a.userLoaded=!0;a.currentUser=b.data})};a.updateCurrentUser()}]);taskBoardControllers.controller("FilesCtrl",["$scope","$routeParams","$http","$window","BoardService",function(a,b,d,c,e){a.file={id:b.fileId,loading:!0};d.get("api/items/1/upload/"+a.file.id).success(function(b){a.file.loading=!1;b.data?(a.file.data=b.data[0],b=new Date,b.setTime(1E3*a.file.data.timestamp),a.file.data.date=b.toLocaleString(),a.file.data.filename="api/uploads/"+a.file.data.filename):a.file.error=!0}).error(function(b){a.file.loading=!1;a.file.error=!0})}]);taskBoardControllers.controller("HeaderCtrl",["$scope","$window","$location","UserService","AuthenticationService","AlertService",function(a,b,d,c,e,f){c.validateToken().error(a.logout);a.display={username:"",smallText:" - Settings"};a.$parent.display=a.display;a.$watch("currentUser",function(b,c){void 0!==b&&void 0!==b.username&&(a.display.username="("+b.username+")")});a.page={boards:!1,settings:!0};-1<d.path().indexOf("boards")&&(a.page.boards=!0,a.page.settings=!1,a.$watch("currentBoard.name",
function(b,c){a.display.smallText=" - "+b}));-1<d.path().indexOf("files")&&(a.page.boards=!1,a.page.settings=!1,a.display.smallText=" - File Viewer");try{$.noty.closeAll()}catch(g){}a.logout=function(){c.logOut().then(function(a){e.reset();delete b.localStorage.token;d.path("/")})}}]);taskBoardControllers.controller("LoginCtrl",["$rootScope","$scope","$location","$window","UserService","AuthenticationService","AlertService",function(a,b,d,c,e,f,g){b.formdata={username:"",password:"",rememberme:!1};b.isSaving=!1;b.clear=function(){$("[name~=Modal]").modal("hide");$(".modal-backdrop").hide()};b.logIn=function(a){b.errors=[];b.isSaving=!0;e.logIn(a.username,a.password,a.rememberme).success(function(a){null!==a.alerts&&g.showAlerts(a.alerts);f.isAuthenticated=!0;c.localStorage.token=
a.data;d.path("/boards")}).error(function(a,c){b.isSaving=!1;b.errors.push(a.message);503===c&&(b.errors[0]+=" Ensure api directory is writable.")})}}]);taskBoardControllers.controller("AutomaticActionsCtrl",["$scope","$interval","BoardService",function(a,b,d){var c="#ffffe0";a.loadingActions=!0;a.actions=[];a.secondarySelection=[];a.boardCategories=[{id:0,name:"Uncategorized",color:c}];a.userList=[{id:0,name:"Unassigned",username:"Unassigned"}];a.actionData={isSaving:!1,board:null,trigger:0,triggerWord:"",secondary:null,action:0,color:null,category:null,assignee:null};a.actionDeleting=[];a.actionTypes=[{id:0,action:"Set item color"},{id:1,action:"Set item category"},
{id:2,action:"Set item assignee"},{id:3,action:"Clear item due date"}];a.actionOptions={triggers:[{id:0,trigger:"Item moves to column"},{id:1,trigger:"Item assigned to user"},{id:2,trigger:"Item set to category"}]};a.updateTriggers=function(){var b=!1;a.actionOptions.triggers.forEach(function(a){2===a.id&&(b=!0)},this);b||a.actionOptions.triggers.push({id:2,trigger:"Item set to category"});1===a.boardCategories.length&&(a.actionOptions.triggers.forEach(function(b,c){2===b.id&&a.actionOptions.triggers.splice(c,
1)}),a.actionTypes.forEach(function(b,c){1===b.id&&a.actionTypes.splice(c,1)}))};var e=function(b){if(null!==b&&void 0!==b){var c;a.boards.forEach(function(a){a.id===b&&(c=a)});return c}},f=function(a){var b=[{id:"0",name:"Uncategorized",color:c}];a&&a.ownCategory&&a.ownCategory.forEach(function(a){b.push(a)});return b},g=function(a){var b=[{id:"0",name:"Unassigned",username:"Unassigned"}];a&&a.sharedUser.forEach(function(a){b.push({id:a.id,name:a.username})});return b},h=function(a){var b=": ",c=
e(a.board_id),d=f(c),h=g(c);switch(parseInt(a.trigger_id)){case 0:c.ownLane.forEach(function(c){c.id===a.secondary_id&&(b+=c.name)});break;case 1:h.forEach(function(c){c.id===a.secondary_id&&(b+=c.name)});break;case 2:d.forEach(function(c){c.id===a.secondary_id&&(b+=c.name)})}return b},m=function(a){var b="",c=e(a.board_id),d=f(c),c=g(c);switch(parseInt(a.action_id)){case 0:b=": "+a.color;break;case 1:d.forEach(function(c){c.id===a.category_id&&(b=": "+c.name)});break;case 2:c.forEach(function(c){c.id===
a.assignee_id&&(b=": "+c.name)})}return b},k=function(b){if(b){var c=[];b.forEach(function(b){var d,e;a.actionOptions.triggers.forEach(function(a){a.id===parseInt(b.trigger_id)&&(d=a.trigger)});a.actionTypes.forEach(function(a){a.id===parseInt(b.action_id)&&(e=a.action)});c.push({id:b.id,board:a.boardLookup[b.board_id],trigger:d+h(b),action:e+m(b)})});a.actions=c}else a.actions=[]};a.loadActions=function(){d.getAutoActions().success(function(b){k(b.data);a.loadingActions=!1})};b(a.loadActions,2E3);
a.$watch("loadingBoards",function(){a.loadingBoards||a.loadActions()});a.addAction=function(){null===a.actionData.secondary||3!==a.actionData.action&&null===a.actionData.color&&null===a.actionData.category&&null===a.actionData.assignee?a.alerts.showAlert({type:"error",text:"One or more required fields are not entered. Automatic Action not added."}):(a.actionData.isSaving=!0,d.addAutoAction(a.actionData).success(function(b){a.actionData.isSaving=!1;a.alerts.showAlerts(b.alerts);"success"==b.alerts[0].type&&
k(b.data)}))};a.removeAction=function(b){a.actionDeleting[b]=!0;d.removeAutoAction(b).success(function(b){a.alerts.showAlerts(b.alerts);k(b.data)})};a.updateSecondary=function(){a.secondarySelection=[];a.actionData.secondary=null;a.actionData.action=0;var b=e(a.actionData.board);a.boardCategories=f(b);a.updateTriggers();a.userList=g(b);if(b)switch(a.actionData.trigger){case 0:a.secondarySelection=b.ownLane;break;case 1:a.secondarySelection=a.userList;break;case 2:a.secondarySelection=a.boardCategories}};
a.getTriggerWord=function(){if(null!==a.actionData.trigger){var b=a.actionOptions.triggers[a.actionData.trigger].trigger.split(" ").pop();a.actionData.triggerWord=b.charAt(0).toUpperCase()+b.slice(1)}a.updateSecondary()};a.getTriggerWord();a.resetActionSecondary=function(){a.actionData.color=null;a.actionData.category=null;a.actionData.assignee=null};c="#ffffe0";a.spectrum=function(b){b=b||c;$("#spectrum").spectrum({color:b,allowEmpty:!1,localStorageKey:"taskboard.colorPalette",showPalette:!0,palette:["#fff #ececec #ffffe0 #ffe0fa #bee7f4 #c3f4b5 #debee8 #ffdea9 #ffbaba".split(" ")],
showSelectionPalette:!0,showButtons:!1,showInput:!0,preferredFormat:"hex3",disabled:null===a.actionData.board})};a.updateColorpicker=function(){null!==a.actionData.board?($("#spectrum").spectrum("enable"),a.actionData.color=$("#spectrum").spectrum("option","color"),a.updateSecondary()):($("#spectrum").spectrum("disable"),a.actionData.color=null)};a.interval=b(function(){null!==a.actionData.board&&(b.cancel(a.interval),a.getTriggerWord())},500);a.$on("$destroy",function(){b.cancel(a.interval)})}]);taskBoardControllers.controller("BoardFormSettingsCtrl",["$scope","BoardService",function(a,b){a.boardFormData={setFocus:!1,boardId:0,isAdd:!0,name:"",lanes:[],laneName:"",categories:[],categoryName:"",color:"#ffffe0",users:[],nameError:!1,lanesError:!1,categoriesError:!1,trackers:[],trackerName:"",bugexpr:"",trackersError:!1,isSaving:!1,updateLanesSorting:function(){var b=this;$(".lanes").sortable({placeholder:"lane-placeholder",stop:function(d,f){b.lanes.length=0;$(f.item).parent().children().each(function(a){b.lanes.push({id:$(this).find(".hidden").text(),
name:$(this).find(".item-text").text(),position:a})});a.$apply()}})},setBoard:function(a){this.reset();this.isAdd=!1;this.boardId=a.id;this.name=a.name;var b=this;void 0!==a.ownLane&&a.ownLane.forEach(function(a){b.lanes.push({id:a.id,name:a.name,position:a.position})});void 0!==a.ownCategory&&a.ownCategory.forEach(function(a){b.categories.push({id:a.id,name:a.name,color:a.color})});void 0!==a.ownTracker&&a.ownTracker.forEach(function(a){b.trackers.push({id:a.id,name:a.name,bugexpr:a.bugexpr})});
void 0!==a.sharedUser&&a.sharedUser.forEach(function(a){b.users[a.id]=!0});this.updateLanesSorting()},addLane:function(){this.lanesError=!1;if(""===this.laneName)this.setAlert(!1,!0,!1,!1,"Column  name cannot be empty.");else{var a=this;this.lanes.forEach(function(b){a.laneName==b.name&&(a.setAlert(!1,!0,!1,!1,"That column name has already been added."),a.lanesError=!0)});this.lanesError||this.lanes.push({id:0,name:this.laneName,position:this.lanes.length});this.laneName="";this.updateLanesSorting()}},
removeLane:function(a){if(!this.isSaving){this.lanes.splice(this.lanes.indexOf(a),1);var b=0;this.lanes.forEach(function(a){a.position=b;b++})}},addCategory:function(){this.categoriesError=!1;if(""===this.categoryName)this.setAlert(!1,!1,!0,!1,"Category name cannot be empty.");else{var a=this;this.categories.forEach(function(b){a.categoryName==b&&this.setAlert(!1,!1,!0,!1,"That category name has already been added.")});this.categoriesError||this.categories.push({id:0,name:this.categoryName,color:this.color});
this.categoryName=""}},removeCategory:function(a){this.isSaving||this.categories.splice(this.categories.indexOf(a),1)},addTracker:function(){this.trackersError=!1;if(""===this.trackerName)this.setAlert(!1,!1,!1,!0,"Issue Tracker URL cannot be empty.");else if(""===this.bugexpr)this.setAlert(!1,!1,!1,!0,"Bug ID regular expression cannot be empty.");else{var a=this;this.trackers.forEach(function(b){a.trackerName==b&&this.setAlert(!1,!1,!1,!0,"That Issue Tracker URL has already been added.")});this.trackersError||
this.trackers.push({id:0,name:this.trackerName,bugexpr:this.bugexpr});this.bugexpr=this.trackerName=""}},removeTracker:function(a){this.isSaving||this.trackers.splice(this.trackers.indexOf(a),1)},setForSaving:function(){this.trackersError=this.categoriesError=this.lanesError=this.nameError=!1;this.isSaving=!0},setAlert:function(b,d,f,g,h){this.nameError=b;this.lanesError=d;this.categoriesError=f;this.trackersError=g;this.isSaving=!1;a.alerts.showAlert({type:"error",text:h})},reset:function(){this.setFocus=
!0;this.boardId=0;this.isAdd=!0;this.name="";this.lanes=[];this.laneName="";this.categories=[];this.categoryName="";this.color="#ffffe0";$("#spectrum").spectrum("enable");a.spectrum("#ffffe0");this.users=[];this.categoriesError=this.lanesError=this.nameError=!1;this.trackers=[];this.bugexpr=this.trackerName="";this.isSaving=this.trackersError=!1},cancel:function(){$(".boardModal").modal("hide");$("#spectrum").spectrum("hide");$("#spectrum").spectrum("enable");var a=this;$(".boardModal").on("hidden.bs.modal",
function(b){a.reset()})}};a.$parent.boardFormData=a.boardFormData;a.spectrum=function(a){a=a||"#ffffe0";$("#spectrum").spectrum({color:a,allowEmpty:!1,localStorageKey:"taskboard.colorPalette",showPalette:!0,palette:["#fff #ececec #ffffe0 #ffe0fa #bee7f4 #c3f4b5 #debee8 #ffdea9 #ffbaba".split(" ")],showSelectionPalette:!0,showButtons:!1,showInput:!0,preferredFormat:"hex3"})};a.addBoard=function(c){c.setForSaving();$("#spectrum").spectrum("disable");d(c)&&b.addBoard(c).success(function(b){a.alerts.showAlerts(b.alerts);
a.updateBoardsList(b.data);c.reset();"success"==b.alerts[0].type&&$(".boardModal").modal("hide")})};a.editBoard=function(c){c.setForSaving();$("#spectrum").spectrum("disable");d(c)&&b.editBoard(c).success(function(b){a.alerts.showAlerts(b.alerts);a.updateBoardsList(b.data);c.reset();"success"==b.alerts[0].type&&$(".boardModal").modal("hide")})};a.editedCategory={};a.editColor=function(b){void 0===a.editedCategory.id?(a.editedCategory.id=b.id,a.editedCategory.name=b.name,a.editedCategory.color=a.boardFormData.color,
a.spectrum(b.color)):a.editedCategory.id!=b.id&&a.editedCategory.name!=b.name&&(a.spectrum(),a.editedCategory={})};a.storeColor=function(b){13===b.which?(a.boardFormData.categories.forEach(function(b){b.id==a.editedCategory.id&&b.name==a.editedCategory.name&&(b.color=a.boardFormData.color)}),a.spectrum(),a.editedCategory={}):27===b.which&&(a.spectrum(),a.editedCategory={})};var d=function(a){return""===a.name?(a.setAlert(!0,!1,!1,!1,"Board name cannot be empty."),!1):0===a.lanes.length?(a.setAlert(!1,
!0,!1,!1,"At least one lane is required."),!1):!0}}]);taskBoardControllers.controller("BoardSettingsCtrl",["$scope","$interval","BoardService",function(a,b,d){var c=!1,e=3,f=function(){c||(c=!0,d.getBoards().success(function(b){a.updateBoardsList(b.data);c=!1;e=3}).error(function(d){e--?c=!1:(b.cancel(a.interval),a.$parent.loadingBoards=!1)}))};f();a.interval=b(f,5E3);a.$on("$destroy",function(){b.cancel(a.interval)});a.userOptions={tasksAt:[{id:0,text:"bottom of column"},{id:1,text:"top of column"}],taskOrder:0,showAnimations:!0,showAssignee:!0};a.boardSort=
{options:[{sort:"id",name:"Creation Date"},{sort:"name",name:"Board Name"}],sort:"name"};a.boardFilter={options:[{filter:"all",name:"All Boards"},{filter:"active",name:"Active"},{filter:"inactive",name:"Inactive"}],filter:"all",userFilter:null};a.boardsFilter=function(b){switch(a.boardFilter.filter){case "all":return!0;case "active":return"1"===b.active;case "inactive":return"0"===b.active}};a.boardsUserFilter=function(b){if(null===a.boardFilter.userFilter)return!0;var c=!1;b.sharedUser.forEach(function(b){console.log(b.id===
a.boardFilter.userFilter);b.id===a.boardFilter.userFilter&&(c=!0)});return c};a.toggleActiveState=function(b){d.toggleActiveState(b).success(function(b){a.alerts.showAlerts(b.alerts);a.boards=b.data})};a.isDeleting=[];a.removeBoard=function(b){noty({text:"Deleting a board cannot be undone.<br>Continue?",layout:"center",type:"information",modal:!0,buttons:[{addClass:"btn btn-default",text:"Ok",onClick:function(c){c.close();a.boards.forEach(function(c){c.id===b&&(a.isDeleting[b]=!0)});d.removeBoard(b).success(function(b){a.alerts.showAlerts(b.alerts);
a.boards=b.data;a.updateUsers(b.users)})}},{addClass:"btn btn-info",text:"Cancel",onClick:function(a){a.close()}}]})}}]);taskBoardControllers.controller("SettingsCtrl",["$scope","UserService","AlertService",function(a,b,d){a.alerts=d;a.users=[];a.boards=[];a.boardNames=[];a.boardLookup={};a.currentUser={};a.slide={open:!1};a.loadingCurrentUser=!0;a.loadingBoards=!0;a.loadingUsers=!0;a.loadCurrentUser=function(){b.currentUser().success(function(b){a.currentUser=b.data;loadOptionsData(b.data);a.loadingCurrentUser=!1})};a.loadCurrentUser();loadOptionsData=function(b){a.currentUser.options.tasksOrder=parseInt(b.options.tasksOrder);
a.currentUser.options.showAnimations=b.options.showAnimations;a.currentUser.options.showAssignee=b.options.showAssignee};a.saveOptions=function(){b.saveOptions(a.currentUser.options.tasksOrder,a.currentUser.options.showAnimations,a.currentUser.options.showAssignee).success(function(a){loadOptionsData({options:a.data})})};a.updateBoardsList=function(b){if(void 0!==b)if(a.loadingBoards=!1,null===b)a.boards=[];else{a.boards=b;var d=[];b.forEach(function(a){d.push({id:a.id,name:a.name,active:a.active})});
a.boardNames=d;b=0;for(var f=d.length;b<f;b++)a.boardLookup[d[b].id]=d[b].name;a.updateActions()}};a.updateUsers=function(b){void 0!==b&&null!==b&&(a.users=b,a.loadingUsers=!1,a.updateActions())};a.actions=[];a.actionsLoading=!0;a.updateActions=function(){"1"===a.currentUser.isAdmin&&b.actions().success(function(b){a.actions=b.data;if(a.actions){var d=new Date;a.actions.forEach(function(a){d.setTime(1E3*a.timestamp);a.date=d.toLocaleString()})}a.actionsLoading=!1})};a.updateActions()}]);taskBoardControllers.controller("UserFormSettingsCtrl",["$scope","UserService",function(a,b){a.userFormData={setFocus:!1,userId:0,isAdd:!0,username:"",password:"",email:"",verifyPass:"",defaultBoard:null,isAdmin:!1,passError:!1,usernameError:!1,emailError:!1,isSaving:!1,setUser:function(a){this.reset();this.isAdd=!1;this.userId=a.id;this.username=a.username;this.email=a.email;this.defaultBoard=a.default_board;this.isAdmin="1"==a.is_admin},reset:function(){$(".popover-dismiss").popover();this.setFocus=
!0;this.userId=0;this.isAdd=!0;this.verifyPass=this.email=this.password=this.username="";this.defaultBoard=null;this.isSaving=this.usernameError=this.passError=this.isAdmin=!1},cancel:function(){$(".userModal").modal("hide");var a=this;$(".userModal").on("hidden.bs.modal",function(b){a.reset()})},setForSaving:function(){this.isSaving=!0;this.passError=this.usernameError=!1},setAlert:function(b,c,e){this.isSaving=!1;this.usernameError=b;this.passError=c;a.alerts.showAlert({type:"error",text:e})}};
a.$parent.userFormData=a.userFormData;a.editUser=function(d){d.setForSaving();""===d.username?d.setAlert(!0,!1,"Username cannot be blank."):(d.isSaving=!0,d.password==d.verifyPass?b.editUser(d).success(function(b){a.alerts.showAlerts(b.alerts);a.updateUsers(b.data);a.updateBoardsList(b.boards);"success"==b.alerts[0].type&&($(".userModal").modal("hide"),d.password="",d.verifyPass="")}):d.setAlert(!1,!0,"Passwords do not match."))};a.addUser=function(d){d.setForSaving();""===d.username?d.setAlert(!0,
!1,"Username cannot be blank."):""===d.password||""===d.verifyPass?d.setAlert(!1,!0,"Password cannot be blank."):(d.isSaving=!0,d.password==d.verifyPass?b.addUser(d).success(function(b){a.alerts.showAlerts(b.alerts);a.updateUsers(b.data);a.updateBoardsList(b.boards);d.reset();"success"==b.alerts[0].type&&$(".userModal").modal("hide")}):d.setAlert(!1,!0,"Passwords do not match."))}}]);taskBoardControllers.controller("UserSettingsCtrl",["$scope","$interval","UserService",function(a,b,d){var c=!1,e=3,f=function(){c||(c=!0,d.getUsers().success(function(b){a.updateUsers(b.data);c=!1;e=3}).error(function(){e--?c=!1:(b.cancel(a.interval),a.$parent.loadingUsers=!1)}))};f();a.interval=b(f,5E3);a.$on("$destroy",function(){b.cancel(a.interval)});a.passwordFormData={currentPass:"",newPass:"",verifyPass:"",newPassError:!1,currentPassError:!1,isSaving:!1,setForSaving:function(){this.currentPassError=
this.newPassError=!1;this.isSaving=!0},setAlert:function(b,c,d){this.newPassError=b;this.currentPassError=c;this.isSaving=!1;a.alerts.showAlert({type:"error",text:d})},reset:function(){this.verifyPass=this.newPass=this.currentPass="";this.isSaving=this.currentPassError=this.newPassError=!1}};a.changePassword=function(b){b.setForSaving();""===b.currentPass?b.setAlert(!1,!0,"Current password cannot be blank."):""===b.newPass||""===b.verifyPass?b.setAlert(!0,!1,"New password cannot be blank."):b.newPass==
b.verifyPass?d.changePassword(b.currentPass,b.newPass).success(function(c){a.alerts.showAlerts(c.alerts);b.isSaving=!1;b.currentPass="";"Password changed."==c.alerts[0].text?b.reset():b.currentPassError=!0}):b.setAlert(!0,!1,"New passwords do not match.")};a.usernameFormData={newUsername:"",usernameError:!1,isSaving:!1,setAlert:function(b){this.isSaving=!1;this.usernameError=!0;a.alerts.showAlert({type:"error",text:b})},reset:function(){this.newUsername="";this.isSaving=this.usernameError=!1}};a.changeUsername=
function(b){a.usernameFormData.isSaving=!0;""===b.newUsername?(b.setAlert("Username cannot be blank."),b.isSaving=!1):d.changeUsername(b.newUsername).success(function(c){a.alerts.showAlerts(c.alerts);a.updateUsers(c.data);a.loadCurrentUser();b.isSaving=!1;b.newUsername=""})};a.emailFormData={newEmail:"",emailError:!1,isSaving:!1,setAlert:function(b){this.isSaving=!1;this.emailError=!0;a.alerts.showAlert({type:"error",text:b})},reset:function(){this.newEmail="";this.isSaving=this.emailError=!1}};a.changeEmail=
function(b){a.emailFormData.isSaving=!0;d.changeEmail(b.newEmail).success(function(c){a.alerts.showAlerts(c.alerts);a.updateUsers(c.data);a.loadCurrentUser();b.isSaving=!1;b.newUsername=""})};a.updatingDefaultBoard=!1;a.setDefaultBoard=function(){a.updatingDefaultBoard=!0;d.changeDefaultBoard(a.currentUser.defaultBoard).success(function(b){a.updatingDefaultBoard=!1;a.updateUsers(b.data);a.alerts.showAlert({type:"success",text:"Default board changed."})})};a.isDeleting=[];a.removeUser=function(b){noty({text:"Deleting a user cannot be undone.<br>Continue?",
layout:"center",type:"information",modal:!0,buttons:[{addClass:"btn btn-default",text:"Ok",onClick:function(c){c.close();a.isDeleting[b]=!0;d.removeUser(b).success(function(b){a.alerts.showAlerts(b.alerts);a.updateUsers(b.data);a.updateBoardsList(b.boards)})}},{addClass:"btn btn-info",text:"Cancel",onClick:function(a){a.close()}}]})}}]);taskBoardServices.factory("AlertService",[function(){var a=function(a){noty({layout:"bottom",type:a.type,text:a.text,timeout:5E3})};return{showAlert:function(b){void 0!==b&&null!==b&&a(b)},showAlerts:function(b){void 0!==b&&null!==b&&b.length&&b.forEach(function(b){a(b)})}}}]);taskBoardServices.factory("AuthenticationService",[function(){return{isAuthenticated:!1,attemptedRoute:null,reset:function(){this.isAuthenticated=!1;this.attemptedRoute=null}}}]);taskBoardServices.factory("BoardService",["$http",function(a){return{getBoards:function(){return a.get("api/boards")},removeBoard:function(b){return a.post("api/boards/remove",{boardId:b})},addBoard:function(b){return a.post("api/boards",{name:b.name,lanes:b.lanes,categories:b.categories,trackers:b.trackers,users:b.users})},editBoard:function(b){return a.post("api/boards/update",{boardId:b.boardId,name:b.name,lanes:b.lanes,categories:b.categories,trackers:b.trackers,users:b.users})},toggleLane:function(b){return a.post("api/lanes/"+
b+"/toggle")},toggleActiveState:function(b){return a.post("api/boards/"+b+"/toggleActive")},getAutoActions:function(){return a.get("api/autoactions")},addAutoAction:function(b){return a.post("api/autoactions",{boardId:b.board,triggerId:b.trigger,secondaryId:b.secondary,actionId:b.action,color:b.color,categoryId:b.category,assigneeId:b.assignee})},removeAutoAction:function(b){return a.post("api/autoactions/remove",{actionId:b})},addItem:function(b,d){return a.post("api/boards/"+d+"/items",{title:b.title,
description:b.description,assignee:b.assignee,category:b.category,color:b.color,dueDate:b.dueDate,points:b.points,lane:b.lane})},updateItem:function(b){return a.post("api/items/"+b.itemId,{title:b.title,description:b.description,assignee:b.assignee,category:b.category,color:b.color,dueDate:b.dueDate,points:b.points,lane:b.lane,position:b.position})},updateItemPositions:function(b){return a.post("api/items/positions",{positions:b})},removeItem:function(b){return a.post("api/items/remove",{itemId:b})},
addItemComment:function(b,d){return a.post("api/items/"+b+"/comment",{text:d})},updateItemComment:function(b,d){return a.post("api/comments/"+b,{text:d})},removeItemComment:function(b,d){return a.post("api/items/"+b+"/comment/remove",{id:d})},addItemAttachment:function(b,d){var c=new FormData;c.append("file",d);return a.post("api/items/"+b+"/upload",c,{transformRequest:angular.identity,headers:{"Content-Type":void 0}})},removeItemAttachment:function(b,d){return a.post("api/items/"+b+"/upload/remove",
{fileId:d})}}}]);taskBoardServices.factory("TokenInterceptor",["$q","$window","$location","AuthenticationService",function(a,b,d,c){return{request:function(a){a.headers=a.headers||{};b.localStorage.token&&(a.headers.Authorization=b.localStorage.token);return a},requestError:function(b){return a.reject(b)},response:function(d){null!==d&&200===d.status&&b.localStorage.token&&!c.isAuthenticated&&(c.isAuthenticated=!0);return d||a.when(d)},responseError:function(e){null!==e&&401===e.status&&(b.localStorage.token||c.isAuthenticated)&&
(delete b.localStorage.token,c.isAuthenticated=!1,d.path("/"));return a.reject(e)}}}]);taskBoardServices.factory("UserService",["$http",function(a){return{currentUser:function(){return a.get("api/users/current")},saveOptions:function(b,d,c){return a.post("api/users/current/options",{tasksOrder:b,showAnimations:d,showAssignee:c})},logIn:function(b,d,c){return a.post("api/login",{username:b,password:d,rememberme:c})},logOut:function(){return a.get("api/logout")},validateToken:function(){return a.get("api/authenticate")},changePassword:function(b,d){return a.post("api/updatepassword",
{currentPass:b,newPass:d})},changeUsername:function(b){return a.post("api/updateusername",{newUsername:b})},changeEmail:function(b){return a.post("api/updateemail",{newEmail:b})},changeDefaultBoard:function(b){return a.post("api/updateboard",{defaultBoard:b})},actions:function(){return a.get("api/actions")},getUsers:function(){return a.get("api/users")},addUser:function(b){return a.post("api/users",{username:b.username,password:b.password,email:b.email,defaultBoard:b.defaultBoard,boardAccess:b.boardAccess,
isAdmin:b.isAdmin})},editUser:function(b){return a.post("api/users/update",{userId:b.userId,newUsername:b.username,password:b.password,email:b.email,defaultBoard:b.defaultBoard,boardAccess:b.boardAccess,isAdmin:b.isAdmin})},removeUser:function(b){return a.post("api/users/remove",{userId:b})}}}]);taskBoardDirectives.directive("clickToEdit",function(){return{restrict:"A",replace:!0,templateUrl:"partials/clickToEdit.html",scope:{value:"=clickToEdit"},controller:["$scope",function(a){a.view={editableValue:a.value,editorEnabled:!1};a.enableEditor=function(){a.view.editableValue=a.value;a.view.editorEnabled=!0};a.save=function(){a.value=a.view.editableValue;a.view.editorEnabled=!1};a.checkKeypress=function(b){13===b.which?(a.save(),b.preventDefault()):27===b.which&&(a.view.editorEnabled=!1,b.preventDefault())}}]}});taskBoardDirectives.directive("fileUpload",["$parse",function(a){return{restrict:"A",link:function(b,d,c){var e=a(c.fileUpload),f=a(c.resetFlag);b.$watch(f,function(a){a&&(d[0].value="",f.assign(b,!1))});d.bind("change",function(){b.$apply(function(){e.assign(b,d[0].files[0])})})}}}]);taskBoardDirectives.directive("focus",["$timeout",function(a){return{link:function(b,d,c){b.$watch(c.focus,function(e){angular.isDefined(e)&&e&&a(function(){d[0].focus();b.$eval(c.focus+" = false")},500)},!0)}}}]);taskBoardDirectives.directive("includeReplace",function(){return{restrict:"A",replace:!0,templateUrl:function(a,b){return b.includeReplace}}});taskBoardDirectives.directive("onLoadCallback",function(){return{restrict:"A",terminal:!0,scope:{callback:"=onLoadCallback"},link:function(a,b,d){a.callback()}}});
